name: Publish Reports

on:
  push:
    paths:
      - "30_drafts/**/*.qmd"
      - "30_drafts/**/*.md"
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  validate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install quarto pandoc

      - name: Validate APA citations
        run: |
          # Check for proper citation format in drafts
          python -c "
          import os
          import re
          
          draft_files = [f for f in os.listdir('30_drafts') if f.endswith(('.md', '.qmd'))]
          
          citation_pattern = r'\d{4}\)\. .+\. https://doi\.org|\d{4}\)\. .+\. Retrieved from'
          
          for file in draft_files:
              with open(os.path.join('30_drafts', file), 'r') as f:
                  content = f.read()
                  if '(20' in content:  # Likely has citations
                      print(f'✓ Found citations in {file}')
              
          print('Citation validation complete')
          "

      - name: Render Quarto documents
        run: |
          # Render all .qmd files in drafts directory
          for file in 30_drafts/*.qmd; do
            if [ -f "$file" ]; then
              echo "Rendering $file..."
              quarto render "$file" --to pdf
              quarto render "$file" --to html
            fi
          done

      - name: Convert Markdown to PDF
        run: |
          # Install pandoc for markdown conversion
          apt-get update && apt-get install -y pandoc wkhtmltopdf
          
          # Convert markdown files to PDF
          for file in 30_drafts/*.md; do
            if [ -f "$file" ]; then
              output_file="40_outputs/$(basename "$file" .md).pdf"
              echo "Converting $file to PDF..."
              pandoc "$file" -o "$output_file" --pdf-engine=wkhtmltopdf
            fi
          done

      - name: Copy outputs
        run: |
          # Copy rendered files to outputs directory
          mkdir -p 40_outputs
          cp 30_drafts/*.pdf 40_outputs/ 2>/dev/null || true
          cp 30_drafts/*.html 40_outputs/ 2>/dev/null || true
          
          # List generated files
          echo "Generated outputs:"
          ls -lh 40_outputs/

      - name: Create Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          files: 40_outputs/*
          tag_name: report-${{ github.run_number }}
          body: |
            # Published Reports
            
            **Date:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.event.head_commit.message }}
            
            Reports have been automatically generated and published.
            
            See attached files for:
            - PDF versions (ready to share)
            - HTML versions (for web viewing)
            
            **Process:**
            - ✓ Python dependencies installed
            - ✓ APA citations validated
            - ✓ Documents rendered (Quarto + Pandoc)
            - ✓ Files published
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push outputs (optional)
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add 40_outputs/
          git commit -m "ci: auto-publish reports for commit ${{ github.event.head_commit.id }}" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: rendered-reports
          path: 40_outputs/
          retention-days: 30

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Report publication failed"
          echo "Check logs above for details"
          exit 1
